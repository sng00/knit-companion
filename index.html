<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Pattern Companion</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    #pdfCanvas {
      display: block;
      max-width: 100%;
      height: auto;
      background: white;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    }

    #pdfCanvasContainer {
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    #pdfWrapper {
      position: relative;
    }

    #rowHighlight {
      position: absolute;
      left: 0;
      right: 0;
      background: rgba(14, 165, 233, 0.2);
      border-top: 1px solid rgba(56, 189, 248, 0.8);
      border-bottom: 1px solid rgba(56, 189, 248, 0.8);
      cursor: grab;
      display: none;
      z-index: 10;
    }

    #dragHandle {
      cursor: col-resize;
      transition: background-color 0.15s ease;
    }

    #dragHandle:hover {
      background-color: rgb(75 85 99);
    }

    #sidebar {
      min-width: 220px;
      max-width: 500px;
    }

    @media (max-width: 767px) {
      #sidebar {
        width: 100% !important;
      }
      #dragHandle {
        display: none !important;
      }
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>

<body class="bg-gray-900 h-screen flex flex-col overflow-hidden text-gray-100 font-sans">
  <main
    id="mainContainer"
    class="flex-1 flex flex-col md:flex-row overflow-hidden relative"
  >
    <!-- PDF Viewer -->
    <div class="flex-1 flex flex-col relative bg-gray-100 h-full min-w-0">
      <!-- Toolbar -->
      <div
        id="pdfToolbar"
        class="bg-gray-800 border-b border-gray-700 p-3 flex items-center justify-between gap-3 z-10 shadow-xl flex-none flex-wrap"
      >
        <!-- Left: navigation, go-to-page, zoom -->
        <div class="flex items-center gap-4 flex-wrap">
          <!-- Page navigation -->
          <div class="flex items-center gap-2">
            <button
              id="prevPageBtn"
              class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors shadow-sm flex items-center gap-2"
            >
              <i class="fas fa-chevron-left"></i>
              <span class="hidden md:inline">Prev</span>
            </button>

            <button
              id="nextPageBtn"
              class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors shadow-sm flex items-center gap-2"
            >
              <i class="fas fa-chevron-right"></i>
              <span class="hidden md:inline">Next</span>
            </button>

            <span class="text-sm md:text-base text-gray-300 ml-2">
              Page <span id="pageNum">1</span> / <span id="pageCount">?</span>
            </span>
          </div>

          <!-- Go to page -->
          <div class="flex items-center gap-1">
            <span class="text-xs text-gray-300">Go to:</span>
            <input
              id="goToPageInput"
              type="number"
              min="1"
              class="w-16 text-xs rounded bg-gray-800 border border-gray-700 text-gray-100 px-2 py-1 focus:outline-none"
            />
            <button
              id="goToPageBtn"
              class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-100"
            >
              Go
            </button>
          </div>

          <!-- Zoom -->
          <div class="flex items-center gap-2">
            <button
              id="zoomOutBtn"
              class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs shadow-sm"
              title="Zoom out"
            >
              <i class="fas fa-minus"></i>
            </button>
            <span id="zoomLabel" class="text-xs text-gray-300 w-12 text-center">100%</span>
            <button
              id="zoomInBtn"
              class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs shadow-sm"
              title="Zoom in"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- Right: highlight height + upload + clear -->
        <div class="flex items-center gap-3 flex-wrap">
          <!-- Highlight height -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-300">Highlight height</span>
            <input
              id="highlightHeightSlider"
              type="range"
              min="20"
              max="120"
              step="5"
              class="w-24"
            />
          </div>

          <button
            id="clearStateBtn"
            class="px-3 py-2 bg-red-600 hover:bg-red-500 text-white rounded text-xs md:text-sm shadow-sm"
            title="Clear saved pattern & state"
          >
            Clear Saved
          </button>

          <label
            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded cursor-pointer shadow-md transition-colors flex items-center gap-2"
          >
            <i class="fas fa-file-upload"></i>
            <span class="hidden sm:inline">Upload Pattern</span>
            <span class="sm:hidden">Upload</span>
            <input type="file" id="fileInput" accept="application/pdf" class="hidden" />
          </label>
        </div>
      </div>

      <!-- PDF canvas -->
      <div class="flex-1 overflow-auto relative bg-gray-200">
        <div
          id="pdfCanvasContainer"
          class="w-full h-full p-4 box-border"
        >
          <div id="pdfWrapper">
            <canvas id="pdfCanvas" class="touch-none"></canvas>
            <div id="rowHighlight"></div>
          </div>
        </div>
        <div
          id="loadingMessage"
          class="absolute inset-0 flex items-center justify-center text-gray-700 text-lg hidden"
        >
          Loading...
        </div>
      </div>
    </div>

    <!-- Resizer -->
    <div
      id="dragHandle"
      class="hidden md:flex w-1 bg-gray-700 flex-shrink-0"
      aria-hidden="true"
    ></div>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="w-full md:w-80 bg-gray-800 flex flex-col border-l border-gray-700 overflow-hidden"
      style="width: 320px;"
    >
      <div class="flex-1 overflow-y-auto p-4 space-y-6">
        <!-- Counters -->
        <div class="bg-gray-900 rounded-lg p-4 shadow-md space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-lg font-semibold text-white">Row Counter</h2>
            <div class="flex items-center gap-1">
              <input
                id="rowInput"
                type="number"
                min="0"
                class="w-16 text-sm rounded bg-gray-800 border border-gray-700 text-gray-100 px-2 py-1 focus:outline-none"
                placeholder="#"
              />
              <button
                id="setRowBtn"
                class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-100"
              >
                Set
              </button>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button
              id="decreaseRow"
              class="px-3 py-2 bg-red-600 hover:bg-red-500 rounded text-white shadow"
            >
              <i class="fas fa-minus"></i>
            </button>
            <span
              id="rowCountDisplay"
              class="text-3xl font-bold min-w-[60px] text-center"
              >0</span
            >
            <button
              id="increaseRow"
              class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded text-white shadow"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <div class="flex justify-end mt-2">
            <button
              id="resetRowBtn"
              class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-100 whitespace-nowrap"
            >
              Reset to 0
            </button>
          </div>
        </div>

        <div class="bg-gray-900 rounded-lg p-4 shadow-md space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-lg font-semibold text-white">Repeat Counter</h2>
            <div class="flex items-center gap-1">
              <input
                id="repeatInput"
                type="number"
                min="0"
                class="w-16 text-sm rounded bg-gray-800 border border-gray-700 text-gray-100 px-2 py-1 focus:outline-none"
                placeholder="#"
              />
              <button
                id="setRepeatBtn"
                class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-100"
              >
                Set
              </button>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button
              id="decreaseRepeat"
              class="px-3 py-2 bg-red-600 hover:bg-red-500 rounded text-white shadow"
            >
              <i class="fas fa-minus"></i>
            </button>
            <span
              id="repeatCountDisplay"
              class="text-3xl font-bold min-w-[60px] text-center"
              >0</span
            >
            <button
              id="increaseRepeat"
              class="px-3 py-2 bg-green-600 hover:bg-green-500 rounded text-white shadow"
            >
              <i class="fas fa-plus"></i>
            </button>
          </div>

          <div class="flex justify-end mt-2">
            <button
              id="resetRepeatBtn"
              class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-gray-100 whitespace-nowrap"
            >
              Reset to 0
            </button>
          </div>
        </div>

        <!-- Bookmarks -->
        <div class="bg-gray-900 rounded-lg p-4 shadow-md space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-lg font-semibold text-white">Bookmarks</h2>
          </div>
          <div class="flex gap-2">
            <input
              id="bookmarkNameInput"
              type="text"
              class="flex-1 text-sm rounded bg-gray-800 border border-gray-700 text-gray-100 px-2 py-1 focus:outline-none"
              placeholder="e.g., Start of sleeves"
            />
            <button
              id="addBookmarkBtn"
              class="text-xs px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-white whitespace-nowrap"
            >
              Add
            </button>
          </div>
          <div id="bookmarksList" class="space-y-2 text-sm text-gray-200">
            <!-- bookmarks injected here -->
          </div>
        </div>

        <!-- Notes -->
        <div class="bg-gray-900 rounded-lg p-4 shadow-md flex flex-col h-64">
          <h2 class="text-lg font-semibold mb-2 text-white">Notes</h2>
          <textarea
            id="notesArea"
            class="flex-1 p-2 rounded bg-gray-800 text-gray-200 resize-none border border-gray-700 focus:outline-none"
          ></textarea>
        </div>
      </div>
    </aside>
  </main>

  <!-- JavaScript -->
  <script>
    // DOM refs
    const fileInput = document.getElementById("fileInput");
    const pdfCanvas = document.getElementById("pdfCanvas");
    const ctx = pdfCanvas.getContext("2d");
    const loadingMessage = document.getElementById("loadingMessage");
    const pdfCanvasContainer = document.getElementById("pdfCanvasContainer");
    const pdfWrapper = document.getElementById("pdfWrapper");
    const rowHighlight = document.getElementById("rowHighlight");

    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const pageNumEl = document.getElementById("pageNum");
    const pageCountEl = document.getElementById("pageCount");

    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomLabel = document.getElementById("zoomLabel");
    const highlightHeightSlider = document.getElementById("highlightHeightSlider");

    const goToPageInput = document.getElementById("goToPageInput");
    const goToPageBtn = document.getElementById("goToPageBtn");

    const clearStateBtn = document.getElementById("clearStateBtn");

    const rowDisplay = document.getElementById("rowCountDisplay");
    const repeatDisplay = document.getElementById("repeatCountDisplay");
    const notesArea = document.getElementById("notesArea");

    const rowInput = document.getElementById("rowInput");
    const setRowBtn = document.getElementById("setRowBtn");
    const repeatInput = document.getElementById("repeatInput");
    const setRepeatBtn = document.getElementById("setRepeatBtn");
    const resetRowBtn = document.getElementById("resetRowBtn");
    const resetRepeatBtn = document.getElementById("resetRepeatBtn");

    const bookmarkNameInput = document.getElementById("bookmarkNameInput");
    const addBookmarkBtn = document.getElementById("addBookmarkBtn");
    const bookmarksListEl = document.getElementById("bookmarksList");

    const sidebar = document.getElementById("sidebar");
    const dragHandle = document.getElementById("dragHandle");
    const mainContainer = document.getElementById("mainContainer");

    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    // State & persistence
    const STORAGE_STATE_KEY = "knitCompanionState";
    const STORAGE_PDF_KEY = "knitCompanionPdfBase64";

    let pdfDoc = null;
    let currentPage = 1;
    let rowCount = 0;
    let repeatCount = 0;
    let zoomLevel = 1;
    let highlightYRatio = null; // 0..1 of canvas height
    let highlightHeightPx = 40;
    let bookmarks = []; // {id, name, page}

    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3;
    const ZOOM_STEP = 0.1;

    function arrayBufferToBase64(buffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function safeSave(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (e) {}
    }

    function safeLoad(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        return null;
      }
    }

    function saveState() {
      const state = {
        currentPage,
        rowCount,
        repeatCount,
        notes: notesArea.value || "",
        zoomLevel,
        sidebarWidth: sidebar.style.width || "",
        highlightYRatio,
        highlightHeightPx,
        bookmarks,
      };
      safeSave(STORAGE_STATE_KEY, JSON.stringify(state));
    }

    function clearState() {
      try {
        localStorage.removeItem(STORAGE_STATE_KEY);
        localStorage.removeItem(STORAGE_PDF_KEY);
      } catch (e) {}
    }

    function restoreState() {
      const raw = safeLoad(STORAGE_STATE_KEY);
      if (!raw) return;
      try {
        const state = JSON.parse(raw);
        if (typeof state.currentPage === "number") currentPage = state.currentPage;
        if (typeof state.rowCount === "number") {
          rowCount = state.rowCount;
          rowDisplay.textContent = rowCount;
        }
        if (typeof state.repeatCount === "number") {
          repeatCount = state.repeatCount;
          repeatDisplay.textContent = repeatCount;
        }
        if (typeof state.zoomLevel === "number") {
          zoomLevel = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, state.zoomLevel));
        }
        if (typeof state.notes === "string") {
          notesArea.value = state.notes;
        }
        if (state.sidebarWidth) {
          sidebar.style.width = state.sidebarWidth;
        }
        if (typeof state.highlightYRatio === "number") {
          highlightYRatio = state.highlightYRatio;
        }
        if (typeof state.highlightHeightPx === "number") {
          highlightHeightPx = state.highlightHeightPx;
        }
        if (Array.isArray(state.bookmarks)) {
          bookmarks = state.bookmarks;
        }
        updateZoomLabel();
        highlightHeightSlider.value = highlightHeightPx;
        renderBookmarksList();
      } catch (e) {}
    }

    // Highlight helpers
    function showHighlight() {
      rowHighlight.style.display = "block";
    }

    function updateHighlightPositionFromRatio() {
      if (!pdfCanvas.height) return;
      if (highlightYRatio == null) {
        highlightYRatio = 0.33; // default 1/3 from top
      }
      const maxTop = pdfCanvas.height - highlightHeightPx;
      let top = highlightYRatio * pdfCanvas.height - highlightHeightPx / 2;
      top = Math.min(maxTop, Math.max(0, top));
      rowHighlight.style.top = top + "px";
      rowHighlight.style.height = highlightHeightPx + "px";
    }

    // PDF rendering
    async function renderPage(num) {
      if (!pdfDoc) return;

      loadingMessage.classList.remove("hidden");

      const page = await pdfDoc.getPage(num);

      const prevHeight = pdfCanvas.height || 1;
      const prevScroll = pdfCanvasContainer.scrollTop;

      const initialViewport = page.getViewport({ scale: 1 });
      const containerWidth = pdfCanvasContainer.clientWidth || window.innerWidth;
      const fitScale = containerWidth / initialViewport.width;
      const scale = fitScale * zoomLevel;

      const viewport = page.getViewport({ scale });

      pdfCanvas.width = viewport.width;
      pdfCanvas.height = viewport.height;
      pdfWrapper.style.width = pdfCanvas.width + "px";
      pdfWrapper.style.height = pdfCanvas.height + "px";

      await page.render({ canvasContext: ctx, viewport }).promise;

      const heightRatio = pdfCanvas.height / prevHeight;
      pdfCanvasContainer.scrollTop = prevScroll * heightRatio;

      showHighlight();
      updateHighlightPositionFromRatio();

      pageNumEl.textContent = num;
      pageCountEl.textContent = pdfDoc.numPages;

      loadingMessage.classList.add("hidden");
      saveState();
    }

    async function loadPDF(data) {
      let pdfData = data;
      if (data instanceof ArrayBuffer) {
        pdfData = new Uint8Array(data);
      } else if (!(data instanceof Uint8Array)) {
        pdfData = new Uint8Array(data);
      }

      pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;

      if (!currentPage || currentPage < 1 || currentPage > pdfDoc.numPages) {
        currentPage = 1;
      }
      await renderPage(currentPage);
    }

    // File input
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = function (event) {
          const pdfData = event.target.result;
          currentPage = 1;
          zoomLevel = 1;
          highlightYRatio = null;
          updateZoomLabel();

          const base64 = arrayBufferToBase64(pdfData);
          safeSave(STORAGE_PDF_KEY, base64);

          loadPDF(pdfData).then(saveState);
        };
        reader.readAsArrayBuffer(file);
      }
    });

    // Restore on load
    (function init() {
      restoreState();
      const pdfBase64 = safeLoad(STORAGE_PDF_KEY);
      if (pdfBase64) {
        try {
          const buffer = base64ToArrayBuffer(pdfBase64);
          loadPDF(buffer);
        } catch (e) {}
      }
    })();

    // Navigation
    prevPageBtn.addEventListener("click", () => {
      if (!pdfDoc || currentPage <= 1) return;
      currentPage--;
      renderPage(currentPage);
    });

    nextPageBtn.addEventListener("click", () => {
      if (!pdfDoc || currentPage >= pdfDoc.numPages) return;
      currentPage++;
      renderPage(currentPage);
    });

    // Go to page
    function goToPageFromInput() {
      if (!pdfDoc) return;
      const val = parseInt(goToPageInput.value, 10);
      if (isNaN(val)) return;
      if (val < 1 || val > pdfDoc.numPages) return;
      currentPage = val;
      renderPage(currentPage);
    }

    goToPageBtn.addEventListener("click", goToPageFromInput);
    goToPageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") goToPageFromInput();
    });

    // Resize handling
    window.addEventListener("resize", () => {
      if (pdfDoc) {
        renderPage(currentPage);
      }
    });

    // Zoom
    function updateZoomLabel() {
      zoomLabel.textContent = Math.round(zoomLevel * 100) + "%";
    }

    zoomInBtn.addEventListener("click", () => {
      zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
      updateZoomLabel();
      if (pdfDoc) renderPage(currentPage);
    });

    zoomOutBtn.addEventListener("click", () => {
      zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
      updateZoomLabel();
      if (pdfDoc) renderPage(currentPage);
    });

    // Highlight height slider
    highlightHeightSlider.addEventListener("input", () => {
      highlightHeightPx = parseInt(highlightHeightSlider.value, 10) || 40;
      updateHighlightPositionFromRatio();
      saveState();
    });

    // Counters & notes
    function setRowCount(value) {
      const v = Math.max(0, Number.isFinite(value) ? value : 0);
      rowCount = v;
      rowDisplay.textContent = rowCount;
      saveState();
    }

    function setRepeatCount(value) {
      const v = Math.max(0, Number.isFinite(value) ? value : 0);
      repeatCount = v;
      repeatDisplay.textContent = repeatCount;
      saveState();
    }

    document.getElementById("increaseRow").onclick = () => {
      setRowCount(rowCount + 1);
    };
    document.getElementById("decreaseRow").onclick = () => {
      if (rowCount > 0) setRowCount(rowCount - 1);
    };

    document.getElementById("increaseRepeat").onclick = () => {
      setRepeatCount(repeatCount + 1);
    };
    document.getElementById("decreaseRepeat").onclick = () => {
      if (repeatCount > 0) setRepeatCount(repeatCount - 1);
    };

    resetRowBtn.addEventListener("click", () => {
      setRowCount(0);
      rowInput.value = "";
    });

    resetRepeatBtn.addEventListener("click", () => {
      setRepeatCount(0);
      repeatInput.value = "";
    });

    notesArea.addEventListener("input", () => {
      saveState();
    });

    function applyRowInput() {
      const val = parseInt(rowInput.value, 10);
      if (!isNaN(val) && val >= 0) {
        setRowCount(val);
      }
    }
    setRowBtn.addEventListener("click", applyRowInput);
    rowInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") applyRowInput();
    });

    function applyRepeatInput() {
      const val = parseInt(repeatInput.value, 10);
      if (!isNaN(val) && val >= 0) {
        setRepeatCount(val);
      }
    }
    setRepeatBtn.addEventListener("click", applyRepeatInput);
    repeatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") applyRepeatInput();
    });

    // Highlight dragging
    let draggingHighlight = false;
    let dragStartY = 0;
    let highlightStartTop = 0;

    rowHighlight.addEventListener("mousedown", (e) => {
      draggingHighlight = true;
      dragStartY = e.clientY;
      highlightStartTop = parseFloat(rowHighlight.style.top || "0") || 0;
      rowHighlight.style.cursor = "grabbing";
      document.body.style.userSelect = "none";
      e.preventDefault();
    });

    window.addEventListener("mousemove", (e) => {
      if (!draggingHighlight) return;
      if (!pdfCanvas.height) return;

      const delta = e.clientY - dragStartY;
      const maxTop = pdfCanvas.height - highlightHeightPx;
      let newTop = highlightStartTop + delta;
      newTop = Math.min(maxTop, Math.max(0, newTop));
      rowHighlight.style.top = newTop + "px";
      highlightYRatio = (newTop + highlightHeightPx / 2) / pdfCanvas.height;
    });

    window.addEventListener("mouseup", () => {
      if (draggingHighlight) {
        draggingHighlight = false;
        rowHighlight.style.cursor = "grab";
        document.body.style.userSelect = "";
        saveState();
      }
    });

    // Bookmarks
    function renderBookmarksList() {
      bookmarksListEl.innerHTML = "";
      if (!bookmarks.length) {
        const empty = document.createElement("div");
        empty.className = "text-xs text-gray-500";
        empty.textContent = "No bookmarks yet.";
        bookmarksListEl.appendChild(empty);
        return;
      }

      bookmarks.forEach((bm) => {
        const row = document.createElement("div");
        row.className =
          "flex items-center justify-between gap-2 bg-gray-800 rounded px-2 py-1";

        const btn = document.createElement("button");
        btn.className =
          "text-left flex-1 text-xs hover:text-blue-300 truncate";
        btn.textContent = `${bm.name || "Bookmark"} (p. ${bm.page})`;
        btn.addEventListener("click", () => {
          if (!pdfDoc) return;
          if (bm.page < 1 || bm.page > pdfDoc.numPages) return;
          currentPage = bm.page;
          renderPage(currentPage);
        });

        const delBtn = document.createElement("button");
        delBtn.className =
          "text-xs text-gray-400 hover:text-red-400 px-1";
        delBtn.innerHTML = '<i class="fas fa-trash"></i>';
        delBtn.addEventListener("click", () => {
          bookmarks = bookmarks.filter((b) => b.id !== bm.id);
          renderBookmarksList();
          saveState();
        });

        row.appendChild(btn);
        row.appendChild(delBtn);
        bookmarksListEl.appendChild(row);
      });
    }

    addBookmarkBtn.addEventListener("click", () => {
      if (!pdfDoc) return;
      const name = bookmarkNameInput.value.trim();
      const bm = {
        id: Date.now().toString(),
        name: name || `Page ${currentPage}`,
        page: currentPage,
      };
      bookmarks.push(bm);
      bookmarkNameInput.value = "";
      renderBookmarksList();
      saveState();
    });

    // Sidebar resizer
    let isDraggingSidebar = false;

    dragHandle.addEventListener("mousedown", (e) => {
      isDraggingSidebar = true;
      document.body.style.userSelect = "none";
      e.preventDefault();
    });

    window.addEventListener("mousemove", (e) => {
      if (!isDraggingSidebar) return;

      const mainRect = mainContainer.getBoundingClientRect();
      const newSidebarWidth = mainRect.right - e.clientX;

      const minWidth = 220;
      const maxWidth = 500;
      const clampedWidth = Math.min(
        maxWidth,
        Math.max(minWidth, newSidebarWidth)
      );

      sidebar.style.width = clampedWidth + "px";

      if (pdfDoc) {
        renderPage(currentPage);
      }
    });

    window.addEventListener("mouseup", () => {
      if (isDraggingSidebar) {
        isDraggingSidebar = false;
        document.body.style.userSelect = "";
        saveState();
      }
    });

    // Clear saved data
    clearStateBtn.addEventListener("click", () => {
      clearState();
      rowCount = 0;
      repeatCount = 0;
      zoomLevel = 1;
      currentPage = 1;
      highlightYRatio = null;
      highlightHeightPx = 40;
      bookmarks = [];
      rowDisplay.textContent = "0";
      repeatDisplay.textContent = "0";
      notesArea.value = "";
      updateZoomLabel();
      pdfDoc = null;
      pageNumEl.textContent = "1";
      pageCountEl.textContent = "?";
      const ctx2 = pdfCanvas.getContext("2d");
      ctx2.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
      rowHighlight.style.display = "none";
      bookmarksListEl.innerHTML = "";
      renderBookmarksList();
      highlightHeightSlider.value = 40;
    });
  </script>
</body>
</html>
